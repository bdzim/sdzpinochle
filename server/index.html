<!DOCTYPE html>
<html>
	<head>
		<title>Single Deck Pinochle</title>
		<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
		<!-- <meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet"> -->
		<style media="screen" type="text/css">
			html, body, .container-fluid, .player, .tall {
				height: 100%;
			}
			button.ui-dialog-titlebar-close {
				display: none;
			}
			.player.turn {
				border: 1px solid red;
			}
			#bid {
				height: auto;
			}
			.bid, .play {
				height: 75%;
			}
			.quarter {
				height: 25%;
				margin: 0;
				padding: 0;
			}
			#hand .playingCard {
				width: 8%;
			}
			.playingCard {
				max-height: 100%;
				max-width: 100%;
			}
			.center {
				text-align: center;
			}
			.full {
				width: 100%;
			}
		</style>
	</head>
	<body>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.0/jquery-ui.min.js"></script>
		<script src="bootstrap/js/bootstrap.min.js"></script>
		<script type="text/javascript">
		/*
		 * example throwing cards on the table
		 */
		var playerid;
		var left;
		var top;
		var right;
		var websocket;
		var lastAction = null;
		var lastCard = null;
		var timer;
		var meldActions = 0;
		var playCount = 0;

		function addToQueue(f) {
			$('body').queue(f);
		}
		
		function showError(msg){
			$('#error').html(msg).show();
			setTimeout(function(){
				$('#error').fadeOut('slow');
			},3000);
		}
		
		function showHand(location, hand, wrap){
			location.empty().show();
			for(var i=0;i<hand.length;i++){
				if (wrap) {
					location.append(createCard(hand[i], 100/hand.length));
				} else {
					location.append(createCard(hand[i],0));
				}
			}
		}
		function createCard(c,width) {
			if (width == 0) {
				return "<img src='cards/" + c + ".svg' class='playingCard' alt='"+c+"'>";
			} else {
				return "<img src='cards/" + c + ".svg' class='playingCard' style='max-width: "+width+"%;' alt='"+c+"'>";
			}
		}
		
		function playCard() {
			var c = $(this).attr("alt");
			send({Type:"Play",PlayedCard:c});
			lastCard = c;
			cardObject = $(this);
			getPlayer(playerid).children(".play").empty().append(cardObject).show();
			$("#hand").children(".playingCard").unbind('click');
			addToQueue(function () {
				setTurn((playerid + 1) % 4);
			});
		}
		
		function processQueue() {
			$('body').dequeue();
		}
				
		$(document).ready(function(){
			websocket = new WebSocket("ws://pinochle:10080/connect");
			//websocket.onopen = function(evt) { showError("Connected!"); };
			//websocket.onclose = function(evt) { onClose(evt) };
			websocket.onmessage = function(evt) { onMessage(evt) };
			websocket.onerror = function(evt) { console.log(evt.data) };
						
			timer = setInterval(processQueue,1000);

			$("#game").dialog({
				buttons:{Go:function () {
					var option = parseInt($("#game input:checked").val());
					send({Type:"Game",Option:option});
					$(this).dialog('close');
					addToQueue(function () {
						$("#we").html("0");
						$("#they").html("0");
					});						}},
				closeOnEscape: false,
				modal: true,
				autoOpen: false,
				minHeight: 0,
				minWidth: 0,
				dialogClass: "well",
			});
			
			$("#hello").dialog({
				buttons:{Go:function () {
					var option = $("#hello input:checked").val();
					send({Type:"Hello",Message:option});
					$(this).dialog('close');
				}},
				closeOnEscape: false,
				modal: true,
				autoOpen: false,
				minHeight: 0,
				minWidth: 0,
				dialogClass: "well",
			});

			$("#continueMeld").dialog({
				buttons:{Continue:function () {
					$(this).dialog('close');
					timer = setInterval(processQueue,1000);
					$(".play").empty();
				}},
				closeOnEscape: false,
				modal: true,
				autoOpen: false,
				minHeight: 0,
				minWidth: 0,
				dialogClass: "well",
			});

			$("#bid").dialog({
				buttons:{Bid:function () {
					var amount = parseInt($("#bid-value").val());
					send({Type:"Bid",Bid:amount});
					$(this).dialog('close');
				}},
				closeOnEscape: false,
				modal: true,
				autoOpen: false,
				minHeight: 0,
				dialogClass: "well",
				minWidth: 0,
			});

			$("#chooseTrump").dialog({
				buttons:{"Set Trump":function () {
					var trump = $("#chooseTrump input:checked").val();
					send({Type:"Trump",Trump:trump});
					$("#trump").html(trump);
					$(this).dialog('close');
				}},
				closeOnEscape: false,
				modal: true,
				autoOpen: false,
				minHeight: 0,
				minWidth: 0,
				dialogClass: "well",
			});
		}); // end of $(document).ready()
		
		function getPlayer(id) {
			if (id == left) return $("#left");
			if (id == partner) return $("#partner");
			if (id == right) return $("#right");
			return $('#bottom');
		}
		
		function appendMessage(msg) {
			//$("#messages").append("<p>" + msg + "</p>");
		}
		
		function send(action) {
			action.Playerid = playerid
			var text = JSON.stringify(action);
			websocket.send(text);
			console.log("Sending - " + text);
		}
		
		function setTurn(id) {
			$(".player").removeClass('turn');
			getPlayer(id).addClass('turn');
		}
		
		function onMessage(evt) {
			console.log("Received - " + evt.data);
			var action = $.parseJSON(evt.data);
			switch (action.Type) {
				case "Message":
					appendMessage(action.Message);
					break;
				case "Hello":
					$("#hello").dialog('open');
					//$("#hello button").click(); // debug
					break;
				case "Game":
					$("#game").dialog('open');
					//$("#game button").click(); // debug
					break;
				case "Trick":
					playCount = 0;
					addToQueue(function () {
						getPlayer(action.Playerid).children(".play").effect("shake");
						setTurn(action.Playerid);
					});
					addToQueue(function (){
						$(".play").empty();
					});
					break;
				case "Deal":
					meldActions = 0;
					playerid = action.Playerid;
					left = (playerid + 1) % 4;
					partner = (playerid + 2) % 4;
					right = (playerid + 3) % 4;
					addToQueue(function(){
						showHand($("#hand"),action.Hand);
						$(".bid").show().empty();
						$(".play").hide();
						$("bid-value").val(20);
						$("#trump").text("N/A");
						getPlayer(action.Dealer).children(".bid").text("Stuck");
						setTurn((action.Dealer + 1) % 4);
					});
					lastAction = null;
					break;
				case "Bid":
					if (action.Playerid == playerid) {
						addToQueue(function(){
							$("#bid").dialog('open');
						});
					} else {
						var current = $("#bid-value").val();
						var setTo = "Pass";
						if (action.Bid && action.Bid > current) {
							$("#bid-value").val(action.Bid);
							setTo = action.Bid;
						}
						addToQueue(function(){
							setTurn((action.Playerid + 1) % 4);
							getPlayer(action.Playerid).children(".bid").effect("shake").text(setTo);
						});
					}
					break;
				case "Trump":
					if (action.Playerid == playerid) {
						$("#chooseTrump").dialog('open');
					} else {
						$("#trump").html(action.Trump);
						setTurn(action.Playerid);
					}
					break;
				case "Play":
					playCount++;
					if (action.Playerid != playerid) {
						var played = createCard(action.PlayedCard,0)
						lastAction = null;
						if (playCount < 4) {
							addToQueue(function () {
								setTurn((action.Playerid + 1) % 4);
								getPlayer(action.Playerid).children(".play").html(played).show();
							});
						} else {
							addToQueue(function(){
								getPlayer(action.Playerid).children(".play").html(played).show();
							});
						}
						return;
					}
					if (lastAction != null && lastCard != null && lastAction.Lead == action.Lead && lastAction.WinningCard == action.WinningCard && lastAction.Trump == action.Trump) {
						addToQueue(function () {
							$("#hand").append(createCard(lastCard,0));
							getPlayer(playerid).children(".play").empty().show();
							setTurn(playerid);
							playCount--;
						});
					} else {
						lastAction = action;
					}
					addToQueue(function () {
						$("#hand").children('.playingCard').click(playCard);
					});
					break;
				case "Meld":
					meldActions++;
					clearInterval(timer);
					getPlayer(action.Playerid).children(".bid").hide();
					showHand(getPlayer(action.Playerid).children(".play"),action.Hand,true);
					if (action.Playerid == playerid) {
						$("#continueMeld").dialog('open');
					}
					if (meldActions == 4) {
						addToQueue(function () {}); // add a dummy function to the queue to "hold" further actions
					}
			}
		}
		</script>
		<div class="container-fluid">
			<div class="row-fluid quarter">
				<div class="span4 tall">
					<dl class="dl-horizontal tall">
						<dt>Trump</dt><dd id="trump">N/A</dd>
						<dt>We</dt><dd id="we"></dd>
						<dt>They</dt><dd id="they"></dd>
					</dl>
				</div>
				<div id="partner" class="span4 player">
					<h4 class="center quarter">Partner</h4>
					<div class="bid center full"></div>
					<div class="play center"></div>
				</div>
			</div>
			<div class="row-fluid quarter">
				<div id="left" class="span4 player">
					<h4 class="center quarter">Opponent</h4>
					<div class="bid center full"></div>
					<div class="play center"></div>
				</div>
				<div class="span4 quarter">
					<div id="continueMeld">
					</div>
					<div id="hello" title="Welcome to SDZPinochle!">
						<label class="radio">
							<input type="radio" name="optionHello" value="create" checked>
							Create (create a game now)
						</label>
						<label class="radio">
							<input type="radio" name="optionHello" value="join">
							Join (wait for others to create a game I can join)
						</label>
						<label class="radio">
							<input type="radio" name="optionHello" value="quit">
							Quit (goodbye!)
						</label>
					</div>
					<div id="bid" title="What's your Bid?">
						<input id="bid-value" type="number" value="20">
					</div>
					<div id="chooseTrump" title="Choose Trump"</div>
						<label class="radio">
							<input type="radio" name="optionTrump" value="D">
							Diamonds
						</label>
						<label class="radio">
							<input type="radio" name="optionTrump" value="S">
							Spades
						</label>
						<label class="radio">
							<input type="radio" name="optionTrump" value="H">
							Hearts
						</label>
						<label class="radio">
							<input type="radio" name="optionTrump" value="C">
							Clubs
						</label>
					</div>
					<div id="game" title="Create a Game">
						<label class="radio">
							<input type="radio" name="optionGame" value="1" checked>
							Play against three AI players and start immediately
						</label>
						<label class="radio">
							<input type="radio" name="optionGame" value="2">
							Play with a human partner against two AI players
						</label>
						<label class="radio">
							<input type="radio" name="optionGame" value="3">
							Play with a human partner against one AI players and 1 Human
						</label>
						<label class="radio">
							<input type="radio" name="optionGame" value="4">
							Play with a human partner against two humans
						</label>
						<label class="radio">
							<input type="radio" name="optionGame" value="5">
							Play against a human with AI partners
						</label>
						<label class="radio">
							<input type="radio" name="optionGame" value="6">
							Go back
						</label>
					</div>
				</div>
				<div id="right" class="span4 player">
					<h4 class="center quarter">Opponent</h4>
					<div class="bid center full"></div>
					<div class="play center"></div>
				</div>
			</div>
			<div class="row-fluid quarter">
				<div id="bottom" class="span4 offset4 player">
					<h4 class="center quarter">Me</h4>
					<div class="bid center full"></div>
					<div class="play center"></div>
				</div>
			</div>
			<div id="hand" class="row-fluid quarter center full">
			</div>
		</div>
	</body>
</html>