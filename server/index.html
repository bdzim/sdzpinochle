<!DOCTYPE html>
<html>
	<head>
		<title>Single Deck Pinochle</title>
		<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
		<link rel="stylesheet" type="text/css" media="all" href="jspc/playingCards.ui.css"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
		<style media="screen" type="text/css">
			.center {
				text-align: center;
			}
			.full {
				width: 100%;
			}
		</style>
	</head>
	<body>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.0/jquery-ui.min.js"></script>
		<script src="bootstrap/js/bootstrap.min.js"></script>
		<script type="text/javascript" src="jspc/playingCards.js"></script>
		<script type="text/javascript" src="jspc/playingCards.ui.js"></script>
		<script type="text/javascript">
		/*
		 * example throwing cards on the table
		 */
		var playerid;
		var left;
		var top;
		var right;
		var websocket;
		var runQueue = [];
		var pause = false;
		
		function showError(msg){
			$('#error').html(msg).show();
			setTimeout(function(){
				$('#error').fadeOut('slow');
			},3000);
		}
		function showHand(location, hand){
			location.html('');
			for(var i=0;i<hand.length;i++){
				location.append(createCard(hand[i]).getHTML());
			}
		}
		function createCard(c) {
			var rank = c.slice(0,1)
			if (rank == "T") {
				rank = "10"
			}
			var suit = c.slice(1)
			return playingCards.card(rank,playingCards.defaults.ranks[rank],suit,playingCards.defaults.suits[suit])
		}
		$(document).ready(function(){
			websocket = new WebSocket("ws://localhost:10080/connect");
			//websocket.onopen = function(evt) { showError("Connected!"); };
			//websocket.onclose = function(evt) { onClose(evt) };
			websocket.onmessage = function(evt) { onMessage(evt) };
			websocket.onerror = function(evt) { console.log(evt.data) };
			
			function running() {
				if (!pause && runQueue.length > 0) runQueue.shift()();
				setTimeout(running,1000);
			}
			running()
			
			$("#bid").hide();
			$("#bid-button").click(function() {
				var amount = parseInt($("#bid-value").val());
				send({Type:"Bid",Bid:amount});
				$("#hand").children('.playingCard').click(function () {
					send({Type:"Play",PlayedCard:$(this).children("[name='card']").attr("value")});
					getPlayer(playerid).children(".play").empty().append($(this));
				});
				$("#bid").hide();
			});

			$("#game").hide();
			$("#game button").click(function() {
				var option = parseInt($("#game input:checked").val());
				send({Type:"Game",Option:option});
				$("#game").hide();
				$("#we").html("0");
				$("#they").html("0");
			});
			
			$("#hello").hide();
			$("#hello button").click(function() {
				var option = $("#hello input:checked").val();
				send({Type:"Hello",Message:option});
				$("#hello").hide();
			});
			
			$("#chooseTrump").hide();
			$("#chooseTrump button").click(function() {
				var trump = $("#chooseTrump input:checked").val();
				send({Type:"Trump",Trump:trump});
				$("#chooseTrump").hide();
			});
		});
		
		function getPlayer(id) {
			if (id == left) return $("#left");
			if (id == partner) return $("#partner");
			if (id == right) return $("#right");
			return $('#bottom');
		}
		
		function appendMessage(msg) {
			//$("#messages").append("<p>" + msg + "</p>");
		}
		
		function send(action) {
			var text = JSON.stringify(action);
			websocket.send(text);
			console.log("Sending - " + text);
		}
		
		function onMessage(evt) {
			console.log("Received - " + evt.data);
			var action = $.parseJSON(evt.data);
			switch (action.Type) {
				case "Message":
					appendMessage(action.Message);
					break;
				case "Hello":
					$("#hello").show();
					break;
				case "Game":
					$("#game").show();
					break;
				case "Trick":
					runQueue.push(function () {
						getPlayer(action.Playerid).children(".play").effect("shake");
					});
					runQueue.push(function (){
						getPlayer(left).children(".play").empty();
						getPlayer(partner).children(".play").empty();
						getPlayer(right).children(".play").empty();
						getPlayer(playerid).children(".play").empty();
					});
					break;
				case "Deal":
					playerid = action.Playerid;
					left = (playerid + 1) % 4;
					partner = (playerid + 2) % 4;
					right = (playerid + 3) % 4;
					runQueue.push(function(){
						showHand($("#hand"),action.Hand);
					});
					$("bid-value").val(20);
					break;
				case "Bid":
					if (action.Playerid == playerid) {
						runQueue.push(function(){
							$("#bid").show();
						});
					} else {
						var current = $("#bid-value").val();
						if (action.Bid && action.Bid > current) {
							$("#bid-value").val(action.Bid);
							runQueue.push(function(){
								getPlayer(action.Playerid).effect("shake");
								getPlayer(action.Playerid).children(".bid").text(action.Bid);
							});
						} else {
							runQueue.push(function(){
								getPlayer(action.Playerid).effect("shake");
								getPlayer(action.Playerid).children(".bid").text("Pass");
							});
						}
					}
					break;
				case "Trump":
					if (action.Playerid == playerid) {
						$("#chooseTrump").show();
					} else {
						$("#trump").html(action.Trump);
					}
					break;
				case "Play":
					if (action.Playerid != playerid) {
						var played = createCard(action.PlayedCard)
						runQueue.push(function(){
							getPlayer(action.Playerid).children(".play").html(played.getHTML());
						});
					}
					break;
				case "Meld":
					pause = true;
					showHand(getPlayer(action.Playerid).children(".meld"),action.Hand);
					if (action.Playerid == playerid) {
						getPlayer(playerid).children(".meld").append("<button>Continue</button").children("button").click(function() {
							$(this).remove();
							pause = false;
							getPlayer(left).children(".meld").empty();
							getPlayer(partner).children(".meld").empty();
							getPlayer(right).children(".meld").empty();
							getPlayer(playerid).children(".meld").empty();
							getPlayer(left).children(".bid").empty();
							getPlayer(partner).children(".bid").empty();
							getPlayer(right).children(".bid").empty();
						});
					}
			}
		}
		</script>
		<div class="container-fluid">
			<div class="row-fluid">
				<div class="span4">
					<table class="table table-bordered table-hover table-condensed"><thead></thead><tbody>
					<tr><td>Trump</td><td id="trump"></td></tr>
					<tr><td>We</td><td id="we"></td></tr>
					<tr><td>They</td><td id="they"></td></tr>
					</tbody></table>
				</div>
				<div id="partner" class="span4 well">
					<h4 class="center">Partner</h4>
					<div class="bid"></div>
					<div class="meld"></div>
					<div class="play"></div>
				</div>
			</div>
			<div class="row-fluid">
				<div id="left" class="span4 well">
					<h4 class="center">Opponent</h4>
					<div class="bid"></div>
					<div class="meld"></div>
					<div class="play"></div>
				</div>
				<div class="span4">
					<div id="hello" class="row-fluid">
						<label class="radio">
  							<input type="radio" name="option" value="create">
  							Create (create a game now)
						</label>
						<label class="radio">
  							<input type="radio" name="option" value="join">
  							Join (wait for others to create a game I can join)
						</label>
						<label class="radio">
  							<input type="radio" name="option" value="quit">
  							Quit (goodbye!)
						</label>
						<button class="btn full">Go</button>
					</div>
					<div id="bid" class="hide">
						<input id="bid-value" type="number" value="20" class="full">
						<button id="bid-button" class="btn full">Bid</bid>
					</div>
					<div id="chooseTrump" class="row-fluid">
						<label class="radio">
							<input type="radio" name="option" value="D">
							Diamonds
						</label>
						<label class="radio">
							<input type="radio" name="option" value="S">
							Spades
						</label>
						<label class="radio">
							<input type="radio" name="option" value="H">
							Hearts
						</label>
						<label class="radio">
							<input type="radio" name="option" value="C">
							Clubs
						</label>
						<button class="btn full">Set Trump</button>
					</div>
					<div id="game" class="row-fluid">
						<label class="radio">
							<input type="radio" name="option" value="1">
							Play against three AI players and start immediately
						</label>
						<label class="radio">
							<input type="radio" name="option" value="2">
							Play with a human partner against two AI players
						</label>
						<label class="radio">
							<input type="radio" name="option" value="3">
							Play with a human partner against one AI players and 1 Human
						</label>
						<label class="radio">
							<input type="radio" name="option" value="4">
							Play with a human partner against two humans
						</label>
						<label class="radio">
							<input type="radio" name="option" value="5">
							Play against a human with AI partners
						</label>
						<label class="radio">
							<input type="radio" name="option" value="6">
							Go back
						</label>
						<button class="btn full">Go</button>
					</div>
				</div>
				<div id="right" class="span4 well">
					<h4 class="center">Opponent</h4>
					<div class="bid"></div>
					<div class="meld"></div>
					<div class="play"></div>
				</div>
			</div>
			<div class="row-fluid">
				<div id="bottom" class="span4 offset4 well">
					<h4 class="center">Me</h4>
					<div class="bid"></div>
					<div class="meld"></div>
					<div class="play"></div>
				</div>
			</div>
			<div id="hand" class="row-fluid">
			</div>
		</div>
	</body>
</html>